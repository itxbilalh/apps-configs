<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>JSON API</title>
</head>

<body style="background: #000; color: #0f0; font-family: monospace; white-space: pre-wrap; padding: 20px;">
    <script>
        (async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const number = urlParams.get('number');

            if (!number || !/^[0-9]{11,13}$/.test(number)) {
                document.body.innerText = JSON.stringify({ error: "Invalid or missing number parameter" }, null, 4);
                return;
            }

            document.body.innerText = "Loading data from sources... (Using Browser IP)";

            const corsProxy = 'https://api.allorigins.win/get?url=';
            const userAgent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';

            async function fetchApi(targetUrl) {
                try {
                    const response = await fetch(corsProxy + encodeURIComponent(targetUrl));
                    const wrapper = await response.json();
                    let data = wrapper.contents;

                    if (data && typeof data === 'string') {
                        // Try to extract JSON if there's HTML wrapper/garbage
                        const start = data.indexOf('{');
                        const end = data.lastIndexOf('}');
                        if (start !== -1 && end !== -1) {
                            return JSON.parse(data.substring(start, end + 1));
                        }
                    }
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    return null;
                }
            }

            let names = new Set();
            let cnics = new Set();
            let addresses = new Set();
            let numbersList = new Set();
            let foundAny = false;

            // Step 1: Parallel fetch from both sources
            const [res1, res2] = await Promise.all([
                fetchApi(`https://omrsite.com/api.php?number=${number}`),
                fetchApi(`https://paksimdetails.xyz/Vigo//A/newnapi/example.php?type=mobile&search=${number}`)
            ]);

            if (res1) {
                if (res1.name) { names.add(res1.name.trim()); foundAny = true; }
                if (res1.cnic) { cnics.add(res1.cnic); foundAny = true; }
                if (res1.address) { addresses.add(res1.address.trim()); foundAny = true; }
                if (res1.numbers) res1.numbers.forEach(n => numbersList.add(n));
            }

            if (Array.isArray(res2)) {
                res2.forEach(r => {
                    if (r.nam) { names.add(r.nam.trim()); foundAny = true; }
                    if (r.cni) { cnics.add(r.cni); foundAny = true; }
                    if (r.adr) { addresses.add(r.adr.trim()); foundAny = true; }
                    if (r.nbr) { numbersList.add(r.nbr); foundAny = true; }
                });
            }

            // Step 2: Auto CNIC expansion if applicable
            if (foundAny && cnics.size > 0 && number.length === 11) {
                const firstCnic = [...cnics][0];
                const cnicRes = await fetchApi(`https://omrsite.com/api.php?number=${firstCnic}`);
                if (cnicRes) {
                    if (cnicRes.name) names.add(cnicRes.name.trim());
                    if (cnicRes.address) addresses.add(cnicRes.address.trim());
                    if (cnicRes.numbers) cnicRes.numbers.forEach(n => numbersList.add(n));
                }
            }

            // Final Response
            if (!foundAny) {
                document.body.innerText = JSON.stringify({ error: "No Result Found" }, null, 4);
            } else {
                const finalJson = {
                    names: [...names],
                    cnics: [...cnics],
                    numbers: [...numbersList],
                    addresses: [...addresses]
                };
                document.body.innerText = JSON.stringify(finalJson, null, 4);
            }
        })();
    </script>
</body>

</html>
